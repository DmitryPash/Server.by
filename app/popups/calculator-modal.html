<div class="calculator">
  <div id="app" ref="app" data-price="1000" data-terms='[{"term":3, "percent":25.9},{"term":6, "percent":25.9},{"term":10, "percent":25.9},{"term":12, "percent":30.9},{"term":18, "percent":30.9},{"term":24, "percent":30.9},{"term":36, "percent":30.9},{"term":48, "percent":30.9}]' data-percents="0, 10, 20, 30, 40, 50, 60" data-percentsr="3, 4, 5, 6" data-installments='["Карта Черепаха", 8, "./images/examples/tortle-card.png"], ["Карта Халва", 2, "./images/examples/halva 1.png"], ["Карта покупок", 3, "./images/examples/fun-card3.png"], ["Карта FUN", 3, "./images/examples/fun-card3.png"], ["Карта Магнит", 3, "./images/examples/magnit-card.png"]'>
<!-- Test attr -->

<!-- <div class="test-attr">
  <br><br><hr><br>
  <div class="priceTest">
    Цена товара - {{calculatorItemPrice}} 
   </div>
  Скрое кредитования - {{terms}}
  <br>
  Первый взнос(кредит) - {{percents}}
  <br>
  installments - {{installments[0]}}
  <br><hr><br><br>
  </div>   -->




<!-- Начальное слово "Без взноса" -> сделать проверку  -->
<!-- Формула подсчета -> нужна формула -->
<!-- Проверить отправку на бэк -->

<!-- Сумма займа * Процентная ставка / 365 (366) дней * Количество дней пользования займом; 2. -->
  

<!--  -->
    <div class="calculator-title">Кредитный калькулятор</div>
    <div class="calculator-alert">
      <div class="calculator-alert-img">
        <img src="./images/icons/!.svg" alt="alt" />
      </div>
      <div class="calculator-alert-txt">
        Расчёт является приблизительным! Окончательные условия уточняйте у
        менежеров!
      </div>
    </div>
    <div class="calculator-item hide">
      <div class="row">
        <div class="col-7">
          <div class="calculator-item-info">
            <div class="calculator-item-marker">НОВИНКА</div>
            <div class="calculator-item-img">
              <a href="#">
                <img src="./images/icons/cart-item-1.png" alt="alt"
              /></a>
            </div>
            <div class="calculator-item-description">
              <a href="#" class="calculator-item-title">
                Acer Aspire 3 A315-22-44UQ NX.HE8EU.00Z
              </a>
              <div class="calculator-item-article">
                <div class="calculator-item-number">КОД ТОВАРА: SJ0065478</div>
                <div class="calculator-item-in-stock">
                  <img src="./images/icons/accept.png" alt="alt" />
                  В НАЛИЧИИ 
                </div>
              </div>
              <div class="calculator-item-price">
                {{calculatorItemPrice}}<span>РУБ.</span>
              </div>
            </div>
          </div>
        </div>
        <div class="col-5">
          <div class="calculator-item-credit">
            <div class="calculator-item-icon">
              <img src="./images/icons/item-icon.svg" alt="alt" />
            </div>
            <div class="calculator-item-cena">
              В кредит от <span>50.20</span> руб.
            </div>
            <div class="calculator-item-cena">
              В рассрочку от <span>132.20</span> руб.
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="calculator-vue">
      <div class="calculator-buttons hide">
        <input
          name="contact"
          type="radio"
          id="radio1"
          v-on:click="changeTab('credit')"
          checked
        />
        <label for="radio1">Кредит от банка</label>
        <input
          name="contact"
          type="radio"
          id="radio2"
          v-on:click="changeTab('installment')"
        />
        <label for="radio2">Рассрочка</label>
        <input
          name="contact"
          type="radio"
          id="radio3"
          v-on:click="changeTab('cards')"
        />
        <label for="radio3">Карты рассрочек</label>
        <div class="calculator-buttons-txt">
          Халва, Черепаха, Магнит и другие
        </div>
      </div>
      <!-- Таб 1 -->
      <div class="calculator-vue-creditBank" v-if="activeTab === 'credit'">
        <div class="calculator-loan hide">
          <div class="calculator-loan-title">
            Срок кредитования,<span>кол-во месяцев</span>
          </div>
          <div class="calculator-loan-btns">
            <div
              class="calculator-loan-btn"
              v-for="(term,index) in termJson"
              :key="term.term"
            >
              <input
                name="credit"
                type="radio"
                :id="'term' + term.term"
                :checked="index===0"
                @change="changeTerm(term.term, term.percent)"
              />
              <label :for="'term' + term.term">{{term.term}} мес</label>
            </div>
          </div>
        </div>
        <div class="calculator-instalment hide">
          <div class="calculator-instalment-title">
            Первый взнос,<span>процент от стоимости товара</span>
          </div>
          <div class="calculator-instalment-btns">
            <div
              class="calculator-instalment-btn"
              v-for="(percent,index) in percents"
              :key="percent"
            >
              <input
                name="credit1"
                type="radio"
                :id="'percent' + percent"
                :checked="index===0"
                @change="changePercents(percent)"
              />
              <label :for="'percent' + percent">{{percent + '%'}}</label>
            </div>
          </div>
        </div>
      </div>
      <!-- Таб 2 -->
      <div class="calculator-vue-installment hide" v-if="activeTab === 'installment'">
        <div class="calculator-vue-info">
          <div class="calculator-vue-description">
            <div class="calculator-vue-title">
              Срок рассрочки, <span>кол-во месяцев</span>
            </div>
            <div class="calculator-vue-para"></div>
          </div>
          <div
            class="calculator-vue-btn"
            v-for="(installment,index) in percentJson"
            :key="index"
          >
            <input
              name="installment"
              type="radio"
              :id="'installment' + index"
              :checked="index===0"
              @change="changeTerm(installment, 0)"
            />
            <label :for="'installment' + index" class="calculator-vue-input"
              >{{installment}} мес</label
            >
          </div>
        </div>
        <div class="calculator-vue-info">
          <div class="calculator-vue-description">
            <div class="calculator-vue-title">
              Первый взнос,<span> % от стоимости товара</span>
            </div>
          </div>
          <div
            class="calculator-vue-btn"
            v-for="(percent,index) in contributionMounths"
            :key="percent"
          >
            <input
              name="contribution"
              type="radio"
              :id="'contribution' + index"
              :checked="index===0"
              @change="changePercents(percent)"
            />
            <label :for="'contribution' + index" class="calculator-vue-input"
              >{{percent}}%</label
            >
          </div>
        </div>
      </div>
      <!-- Таб 3 -->
      <div class="calculator-vue-cards hide" v-if="activeTab === 'cards'">
        <div class="row">
          <div
            class="col-3 col-calculator-vue"
            v-for="(percent,index) in installments"
            :key="index"
          >
            <input
              name="cart"
              type="radio"
              :id="'installment' + index"
              :checked="index===0"
              @change="changePercents(percent)"
            />
            <label :for="'installment' + index" class="calculator-vue-card valign-center">
              <div class="calculator-vue-img">
                <img v-bind:src="percent[2]" alt="alt" />
              </div>
              <div class="calculator-vue-description">
                <div class="calculator-vue-title">{{percent[0]}}</div>
                <div class="calculator-vue-txt">
                  Рассрочка: <span>{{percent[1]}} мес</span>
                </div>
              </div>
            </label>
          </div>
        </div>
      </div>
    </div>

    <div class="calculator-bar hide">
      <div class="row">
        <div class="col-calculator-74 col-md-12">
          <div class="calculator-table">
            <table>
              <tbody>
                <tr class="calculator-table-top">
                  <th>Типы услуг</th>
                  <th>Первый взнос</th>
                  <th>Платеж, в месяц</th>
                  <th>Всего переплата</th>
                  <th>Итого</th>
                </tr>
                <tr class="calculator-table-bottom">
                  <!-- Тип услуг -->
                  <td v-if="activeTab === 'credit'">Кредит</td>
                  <td v-if="activeTab === 'installment'">Рассрочка</td>
                  <td v-if="activeTab === 'cards'">Карта 
                    рассрочки</td>

                  <!-- Первый взнос -->
                  <!-- Сделать проверку в выч.св или метод -->
                  <td v-if="activeTab === 'credit'">{{calcFirstPay()}}</td>
                  <td v-if="activeTab === 'installment'">{{calcFirstPay()}}</td>
                  <td v-if="activeTab === 'cards'">{{calcFirstPay()}}</td>

                  <!-- Платеж в мес. -->
                  <td v-if="activeTab === 'credit'">{{calcMouth()}} <span>РУБ.</span></td>
                  <td v-if="activeTab === 'installment'">{{calcMouth()}}<span>РУБ.</span></td>
                  <td v-if="activeTab === 'cards'">{{calcMouth()}}<span>РУБ.</span></td>

                  <!-- Всего переплата -->
                  <td v-if="activeTab === 'credit'">{{calcOverPay()}}<span>РУБ.</span></td>
                  <td v-if="activeTab === 'installment'">0<span>РУБ.</span></td>
                  <td v-if="activeTab === 'cards'">0<span>РУБ.</span></td>

                   <!-- Итого -->
                   <!-- Сумма займа * Процентная ставка / 365 (366) дней * Количество дней пользования займом; 2. -->

                   <td v-if="activeTab === 'credit'">{{calcTotal()}}<span>РУБ.</span></td>
                   <td v-if="activeTab === 'installment'">{{calculatorItemPrice}}<span>РУБ.</span></td>
                   <td v-if="activeTab === 'cards'">{{calcTotal()}}<span>РУБ.</span></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="col-calculator-26 flex valign-end">
          <a href="#" class="calculator-btn ui-btn" @click="setData">оформить заказ</a>
        </div>
      </div>
    </div>
    <div class="calculator-mob-article flex">
      <div class="calculator-mob-img">
        <a href="#"> <img src="./images/icons/cart-item-1.png" alt="alt" /></a>
      </div>
      <div class="calculator-mob-description">
        <a href="#" class="calculator-mob-title">
          Acer Aspire 3 A315-22-44UQ NX.HE8EU.00Z
        </a>
        <div class="calculator-mob-number">Код товара: SJ0065478</div>
        <div class="calculator-mob-price">{{calculatorItemPrice}}<span>РУБ.</span></div>
      </div>
    </div>
    <!-- Адаптив блок -->
    <div class="calculator-mob-form show">
      <form action="">
        <div class="calculator-mob-step">
          шаг-1 - <span>Выберите тип услуги</span>
        </div>
        <div class="calculator-mob-select">
          <!-- <select @change="changeCredit(e)" v-model="Credit"> -->
          <select v-model="Credit">
            <option selected value="seceltedChoose">Выбрать</option>
            <option value="Credit">Кредит</option>
            <option value="Credit_R">Рассрочка</option>
          </select>
        </div>
        <!-- Шаг 2 -->
        <template v-if="Credit !== 'seceltedChoose'">
          <div class="calculator-mob-step">
            шаг-2 - <span>Выберите срок кредитования</span>
          </div>
          <div class="calculator-mob-select">
            <select  v-if="Credit == 'Credit'" @change="choosePrise($event)">
              <option selected dibled>Выбрать</option>
              <option v-for="term in termJson" :value="term.term" :data-percent="term.percent"  :key="term.term" >

                {{term.term + " " + 'мес'}}
                
              </option>           
            </select>
            <select v-if="Credit == 'Credit_R'" @change="chooseRasrochka($event)">
              <option selected dibled>Выбрать</option>
              <option v-for="cnt in percentJson" :value="cnt"  :key="cnt" >
                {{cnt + " " + 'мес'}}
              </option>
            
            </select>
            
          </div>
          <!-- Шаг 3 -->
          <div class="calculator-mob-step">
            шаг-3 - <span>Выберите первый взнос</span>
          </div>
          <div class="calculator-mob-select">
            <select @change="choosePercent($event)">
              <option selected disabled>Выбрать</option>
              <template v-if="Credit == 'Credit'">
                <option v-for="(percent,index) in percents"
                :key="percent" :value="percent" >
                  {{percent}}
                </option>
              </template>
              <template v-if="Credit == 'Credit_R'">
                <option v-for='cnm in contributionMounths' :key="cnm" >
                  {{cnm}}
                </option>
              </template>
             
            </select>
          </div>
          <!-- Расчет -->
          <div class="calculator-mob-box">
            <div class="calculator-mob-credit">
              <div class="calculator-mob-loan" v-if="Credit == 'Credit'">{{creditText}}</div>
              <div class="calculator-mob-loan" v-if="Credit == 'Credit_R'">{{creditTextR}}</div>

              <div class="calculator-mob-cena" v-if="Credit == 'Credit'">{{calcTotal()}}<span>РУБ.</span></div>
              <div class="calculator-mob-cena" v-if="Credit == 'Credit_R'">{{calculatorItemPrice}}<span>РУБ.</span></div>

            </div>
            <div class="calculator-mob-table">
              <div class="calculator-mob-info">
                <div class="calculator-mob-txt">Первый взнос</div>
                <div class="calculator-mob-cena" v-if="Credit == 'Credit'">{{calcFirstPay()}}<span>РУБ.</span></div>
                <div class="calculator-mob-cena" v-if="Credit == 'Credit_R'">{{calcFirstPay()}}<span>РУБ.</span></div>
                <div class="calculator-mob-cena" v-if="activeTab === 'cards'">Без взноса<span>РУБ.</span></div>
              </div>
              <div class="calculator-mob-info">
                <div class="calculator-mob-txt">Платеж в месяц</div>
                <div class="calculator-mob-cena" v-if="Credit == 'Credit'">{{calcMouth()}}<span>РУБ.</span></div>
                <div class="calculator-mob-cena"v-if="Credit == 'Credit_R'">{{calcMouth()}}<span>РУБ.</span></div>
                <div class="calculator-mob-cena" v-if="activeTab === 'cards'">Без взноса<span>РУБ.</span></div>

              </div>
              <div class="calculator-mob-info">
                <div class="calculator-mob-txt">Всего переплата</div>
                <div class="calculator-mob-cena" v-if="Credit == 'Credit'">{{calcOverPay()}}<span>РУБ.</span></div>
                <div class="calculator-mob-cena"v-if="Credit == 'Credit_R'">{{calcOverPay()}}<span>РУБ.</span></div>
                <div class="calculator-mob-cena" v-if="activeTab === 'cards'">Без взноса<span>РУБ.</span></div>

              </div>
            </div>
          </div>
          <button class="calculator-mob-btn ui-btn">оформить заказ</button>
        </template>
  
        <!-- End -->
        <a href="javascript:void(0)" class="calculator-mob-close">
          <img src="./images/icons/Крестик для иконки.svg" alt="alt" />
          Закрыть калькулятор
        </a>
      </form>
    </div>
  </div>
  <script>

    $( document ).ready(function() {

      $(document).on('click', '.calculator-mob-close', function() {
        $.magnificPopup.close();
      })


      new Vue({
      el: "#app",
      data: {
        // Карты рассрочек
        installments: [],

        // Табы
        activeTab: "credit",
        currentTerm: "",
     

        // Кол-во месяцов
        resultTerms:null,

        // Первый взнос
        resultPercents:0,

        // Цена товара
        calculatorItemPrice: null,

        // Кредит
        termJson: null,
        terms: [],

        // Процент срока кредитования
        percent: null,

        // Первый взнос
        percents: [],

        // Рассрочка
        percentJson: null,
        contributionMounths: [0],

        // Адаптив
        Credit: "seceltedChoose",
        creditText: 'Кредит',
        creditTextR: 'Рассрочка',
        
        // Сумарные переменные 
        calcMouthPercent: null,
        result: {
          resultFirstPay: null,
          resultMauth: null,
          resultOverPay: null,
          resultTotal: null,
        },
        

        // Back
        getData: {
          type: null,
          term: null,
          firstPay: null,
        },
        
      },
     
      methods: {
        changeTerm(term, percent) {
          this.resultTerms = term;
          this.percent = percent
          console.log(this.resultTerms);
          console.log(this.percent);
        },
        changePercents(percent) {
          if(percent[1] === undefined) {
            this.resultPercents = percent;
          }else {
            this.resultPercents = percent[1];
          }
        },
      
        choosePrise(event) {
          this.resultTerms = event.target.value 
          this.percent = event.target.options[event.target.options.selectedIndex].getAttribute('data-percent');
          console.log(this.resultTerms);
          console.log(this.percent);
        },
        
        choosePercent(event) {
         this.resultPercents = event.target.value
        },

        chooseRasrochka(event) {
          this.resultTerms = event.target.value
        },


        setData(){
            this.getData.push(this.resultTerms)

            this.getData.push(this.resultPercents)
         

            const dataContact = JSON.stringify(this.getData)
            // Отправляем данные 
                // fetch(" ", {
                //       method: "POST",
                //       body: JSON.stringify(str),
                //       headers: {
                //         "Content-type": "application/json; charset=UTF-8",
                //       },
                //     })
                //       .then((response) => response.json())
                //       .then((data) => {
                //         console.log(data)
                //     })
        },

        changeTab(tab) {
          this.activeTab = tab;
         
        },


        //  Формула рассчета -  ((цена - первый взнос) * (ежемес.процент / 12 * кол-месц) / 100) + (цена - первый взнос) = итого
        calcFirstPay: function () {
          // Переменная первого взноса
          this.result.resultFirstPay = (this.calculatorItemPrice / 100 * this.resultPercents);
          if(this.activeTab === 'cards' || this.activeTab === 'installment' || this.Credit === 'Credit_R') {
             return 'Без взноса'
            } else if (this.Credit === 'Credit') {
              return  `${this.result.resultFirstPay.toFixed(2)} РУБ`
            } 

            if(this.result.resultFirstPay >= 1) { 
              return `${this.result.resultFirstPay.toFixed(2)} РУБ`;
              } else {
                return 'Без взноса'
              }
          },


        calcTotal: function () {
          // console.log(this.activeTab)
            if(this.activeTab === 'cards') {
             return this.calculatorItemPrice
            } else if (this.activeTab === 'installment') {
              return this.calculatorItemPrice
            } else if (this.Credit === 'Credit') {
                this.calcMouthPercent = (this.percent / 12 * this.resultTerms) / 100;
                this.result.resultTotal = (((this.calculatorItemPrice - this.result.resultFirstPay) *  this.calcMouthPercent) + (this.calculatorItemPrice - this.result.resultFirstPay));
                return  this.result.resultTotal.toFixed(2)
            }else {
              // Переменная процент выбраного месяца
                this.calcMouthPercent = (this.percent / 12 * this.resultTerms) / 100;
                this.result.resultTotal = (((this.calculatorItemPrice - this.result.resultFirstPay) *  this.calcMouthPercent) + (this.calculatorItemPrice - this.result.resultFirstPay));
                return  this.result.resultTotal.toFixed(2)
            }
          },


          calcMouth: function() {
            if(this.activeTab === 'cards') {
              return (this.calculatorItemPrice / this.resultPercents).toFixed(2)
            } else if (this.activeTab === 'installment' || this.Credit === 'Credit_R') {
              return (this.calculatorItemPrice / this.resultTerms).toFixed(2)
            } else { 
              this.result.resultMauth = ((((this.calculatorItemPrice - this.result.resultFirstPay) *  this.calcMouthPercent) + (this.calculatorItemPrice - this.result.resultFirstPay)) / this.resultTerms)
              return this.result.resultMauth.toFixed(2)
            }
          },


          calcOverPay: function() {
            if(this.Credit === 'Credit_R')  {
             return this.result.resultOverPay = 0
            } else {
              this.result.resultOverPay = ((this.calculatorItemPrice / 100 * this.resultPercents + (((this.calculatorItemPrice - this.result.resultFirstPay) *  this.calcMouthPercent) + (this.calculatorItemPrice - this.result.resultFirstPay))) - this.calculatorItemPrice)
            return this.result.resultOverPay.toFixed(2)
            }
        
          },
      },


      mounted() {
        this.currentTerm = this.terms[0];
        
        this.calculatorItemPrice = Number(this.$refs.app.dataset.price);
         

        // Кредит
        this.termJson =  JSON.parse(this.$refs.app.dataset.terms || []);
        this.resultTerms = this.termJson[0].term
        // Первый взнос
        this.percents = this.$refs.app.dataset.percents;
       
        let PercentsSplit = this.percents.split(',').map(function(item) {
          return parseInt(item, 10);
        })
        this.percents = PercentsSplit
        // ????????????????????????????????????????????????? поставь 0 и будет -> infinity
        this.percent = this.percents[1]
       
        // Рассрочка 
          // Срок рассрочки
        this.percentJson = this.$refs.app.dataset.percentsr;
        let percentJsonSplit = this.percentJson.split(', ').map(function(it) {
          return parseInt(it,10)
        })
        this.percentJson = percentJsonSplit



        // Карты рассрочек
        this.installments = JSON.parse("[" + this.$refs.app.dataset.installments + "]")  
        
        this.resultPercents = this.installments[0][1]
        console.log(this.installments[0][1])

        
      },

   


    });
    })
    



  </script>
</div>
